<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<!-- iOS Full screen -->
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<meta name="apple-mobile-web-app-status-bar-style" content="black" />

	<link rel="stylesheet" href="/static/css/main.css">
	<link rel="stylesheet" href="/static/css/bootstrap.min.css">
	<script src="/static/js/jquery.min.js"></script>
	
	<!-- Range slider -->
	<link rel="stylesheet" href="/static/css/rangeslider.css">
	<script src="/static/js/rangeslider.js"></script>

	<!-- Web sockets -->
	<script src="/socket.io/socket.io.js"></script>
	

<script>
	// fullscreen on android
	// if(navigator.userAgent.match(/Android/i)){
		window.scrollTo(0,1);
	// }


	$(function() {
		var soundMin = 150;
		var auxnumber = window.location.pathname.substring(5).replace ( /[^\d.]/g, '' )

		var socket = io.connect();

		socket.on('connect', function() {
		// Connected, let's sign-up to receive messages for this room
			socket.emit('subscribe', "announcements");
			socket.emit('subscribe', "name/input");
			socket.emit('subscribe', "name/aux");
			socket.emit('subscribe', "volume/aux/"+auxnumber);
			socket.emit("request", "auxNames");
			socket.emit("request", "inputAuxLevelVolume"+auxnumber);
			socket.emit("request", "inputNames");
		});

		socket.on('announcements', function (data) {
			data = JSON.parse(data);
			if (data["name"] == "consoleConfig")
			{
				createFaders(data["channelInputs"]);
			}
			// console.log('Annoucement:', data);
		});

		socket.on('name/input', function (data) {
			data = JSON.parse(data);
			updateFaderName(data["c"], data["n"]);
			// console.log('Incoming message:', data);
		});

		socket.on('name/aux', function (data) {
			console.log('Incoming message:', data);
		});

		socket.on('volume/aux', function (data) {
			data = JSON.parse(data);
			if (data["a"] == auxnumber)
				updateFaderLevel(data["c"], data["v"]);
			// console.log('Incoming message:', data);
		});

		function createFaders(channels)
		{
			// initialising is important or you may get a random
			// 'undefined' when appending to it
			var input = ""; 
			var faderLevel = 0;
			for (i = 0; i < channels; i++)
			{
				input += '<div class="fader"><input id="fader-'+(i+1)+'" type="range" min="0" max="100" value="'+faderLevel+'"data-rangeslider data-orientation="vertical"><p id="name-'+(i+1)+'" class="name">Channel '+(i+1)+'</p></div>'
			}

			$( "div#faders" ).append(input);
			createRanges();
		}
		
		function updateFaderLevel(channel, level)
		{
			var selector = "input#fader-"+(channel);
			var faderLevel = 100;
			if (level <= 0)
			{
				faderLevel = 100-(Math.log10(1-level)/Math.log10(1+soundMin))*100
			}
			console.log(selector);
			$(selector).val(faderLevel).change();
		}

		function updateFaderName(channel, name)
		{
			var selector = "p#name-"+(channel);
			$(selector).text(name);
		}

		function screenSizeUpdate()
		{
			var height = $(window).height();
			console.log(height);
			$("#faders").height(height);
		}
		
		screenSizeUpdate();
		window.addEventListener('orientationchange', screenSizeUpdate);

		function createRanges()
		{
			var $document = $(document);
			var selector = '[data-rangeslider]';
			var $element = $(selector);
			// For ie8 support
			var textContent = ('textContent' in document) ? 'textContent' : 'innerText';
			
			// Basic rangeslider initialization
			$element.rangeslider({
				// Deactivate the feature detection
				polyfill: false,
				// Callback function
				onInit: function() {

				},

				// Callback function
				onSlide: function(position, value) {

				},

				// Callback function
				onSlideEnd: function(position, value) {
					var auxnumber = window.location.pathname.substring(5).replace ( /[^\d.]/g, '' )
					var ch = (this.$element[0].id).substr(6);
					// var value = value;
					volume = -(Math.pow(10,-((value-100)/100)*Math.log10(1+soundMin))-1)
					console.log(volume);
					volume = Math.round(volume*100)/100
					console.log(ch);
					var obj = {
						"a":auxnumber,
						"c":ch,
						"v":volume
					};
					socket.emit("volume/aux", JSON.stringify(obj));
					// $.get( "/sd9/auxupdate/?aux="+auxnumber+"&ch="+ch+"&vol="+volume, function( data ) {
					// });
				}
			});
		};
	});
</script>
	
</head>
<body>
	<div>
		<div id="faders" class="faders" ></div>
	</div>
</body>
</html>